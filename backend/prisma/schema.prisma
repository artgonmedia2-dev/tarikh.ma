// Tarikh.ma - Schéma de données
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum DocumentType {
  MANUSCRIPT
  PHOTO
  VIDEO
  MAP
  REGISTER
  OTHER
}

enum DocumentStatus {
  DRAFT
  PUBLISHED
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String?
  roleId       String     @map("role_id")
  status       UserStatus @default(ACTIVE)
  lastLoginAt  DateTime?  @map("last_login_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  role           Role          @relation(fields: [roleId], references: [id], onDelete: Restrict)
  favorites      Favorite[]
  documentViews  DocumentView[]
  documentsCreated Document[]  @relation("DocumentCreatedBy")

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  label       String?
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Document {
  id              String         @id @default(cuid())
  reference       String         @unique
  title           String
  summary         String?        @db.Text
  publishedAt     DateTime?      @map("published_at")
  type            DocumentType
  status          DocumentStatus @default(DRAFT)
  themes          String[]       @default([])
  languages       String[]       @default([])
  region          String?
  archiveLocation String?        @map("archive_location")
  fileUrl         String?        @map("file_url")
  thumbnailUrl    String?        @map("thumbnail_url")
  keywords        String[]       @default([])
  createdById     String?        @map("created_by_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  createdBy   User?          @relation("DocumentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  favorites   Favorite[]
  documentViews DocumentView[]

  @@map("documents")
}

model Favorite {
  userId     String   @map("user_id")
  documentId String   @map("document_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([userId, documentId])
  @@map("favorites")
}

model DocumentView {
  id         String   @id @default(cuid())
  documentId String   @map("document_id")
  userId     String?  @map("user_id")
  ip         String?
  viewedAt   DateTime @default(now()) @map("viewed_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([viewedAt])
  @@map("document_views")
}
